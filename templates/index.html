{% extends "layout.html" %}
{% block content %}
<div class="grid">
  <section class="browser">
    <h2>Navegador simulado</h2>
    <!-- Adicionando o ID para a comunicação do front-end com o iframe -->
    <iframe id="browser-frame" src="/browser" style="width:100%;height:70vh;border:1px solid #333;border-radius:8px;"></iframe>
  </section>

  <section class="side">
    <h2>Leitura & Resposta</h2>

    <label class="blk">Snapshot lido</label>
    <pre id="read-snapshot" class="pane">{{ snapshot or "Aguardando..." }}</pre>

    <label class="blk" style="margin-top: 16px;">Resposta sugerida</label>
    <pre id="reply-preview" class="pane">{{ reply or "Aguardando..." }}</pre>

    <div class="controls" style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap;">
      <button id="btn-start" class="btn primary">▶ Iniciar loop</button>
      <button id="btn-stop" class="btn danger" disabled>■ Parar</button>
      <button id="btn-run-once" class="btn">Run once</button>
    </div>

    <label class="blk" style="margin-top:16px;">Logs</label>
    <pre id="logs" class="pane" style="height:180px; overflow:auto;">[UI] Aguardando conexão...</pre>
  </section>
</div>

<style>
  .grid {
    display:grid;
    grid-template-columns: 1fr 420px;
    gap:16px;
    align-items:start;
  }
  .pane {
    background:#111;
    color:#ddd;
    border:1px solid #333;
    border-radius:8px;
    padding:10px 12px;
    white-space:pre-wrap;
    word-break:break-word;
    min-height:72px;
  }
  .blk { display:block; margin:6px 0 4px; color:#bbb; }
  .btn {
    background:#222; color:#eee; border:1px solid #444;
    padding:8px 12px; border-radius:8px; cursor:pointer;
  }
  .btn:disabled { opacity:0.6; cursor:not-allowed; }
  .btn.primary { background:#2d6cdf; border-color:#2d6cdf; }
  .btn.danger { background:#b01e1e; border-color:#b01e1e; }
  @media (max-width: 1100px){
    .grid { grid-template-columns: 1fr; }
  }
</style>

<script>
(function () {
  const $snapshot = document.getElementById('read-snapshot');
  const $reply = document.getElementById('reply-preview');
  const $logs = document.getElementById('logs');
  const $btnStart = document.getElementById('btn-start');
  const $btnStop = document.getElementById('btn-stop');
  const $btnOnce = document.getElementById('btn-run-once');

  function log(line) {
    const now = new Date().toLocaleTimeString();
    $logs.textContent += `\n[${now}] ${line}`;
    $logs.scrollTop = $logs.scrollHeight;
  }

  // --- WebSocket para eventos do backend ---
  let ws;
  function connectWS() {
    try {
      ws = new WebSocket((location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host + '/ws');
      ws.onopen = () => log('Conectado ao WS.');
      ws.onclose = () => log('WS fechado.');
      ws.onerror = (e) => log('WS erro: ' + (e?.message || ''));
      ws.onmessage = (ev) => {
        let msg = ev.data;
        try { msg = JSON.parse(ev.data); } catch (_){ /* pode vir como texto simples */ }

        // formatos aceitos:
        // 1) texto puro (log)
        // 2) {type:"log"|"snapshot"|"reply"|"state", data:"..."}
        if (typeof msg === 'string') {
          log(msg);
          return;
        }
        switch (msg.type) {
          case 'log':
            log(msg.data || '');
            break;
          case 'snapshot':
            $snapshot.textContent = msg.data || '';
            break;
          case 'reply':
            $reply.textContent = msg.data || '';
            break;
          case 'state':
            // esperado: {running: true|false}
            const running = !!msg.data?.running;
            $btnStart.disabled = running;
            $btnStop.disabled = !running;
            break;
          default:
            log('[WS] mensagem desconhecida.');
        }
      };
    } catch (e) {
      log('Falha ao conectar WS: ' + e.message);
    }
  }
  connectWS();

  // --- ações ---
  async function postJson(path, body) {
    const res = await fetch(path, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: body ? JSON.stringify(body) : null
    });
    if (!res.ok) {
      const t = await res.text();
      throw new Error(t || ('HTTP ' + res.status));
    }
    return res.json().catch(() => ({}));
  }

  $btnStart.addEventListener('click', async () => {
    try {
      await postJson('/start');
      $btnStart.disabled = true;
      $btnStop.disabled = false;
      log('Loop iniciado.');
    } catch (e) {
      log('Erro ao iniciar: ' + e.message);
    }
  });

  $btnStop.addEventListener('click', async () => {
    try {
      await postJson('/stop');
      $btnStart.disabled = false;
      $btnStop.disabled = true;
      log('Loop parado.');
    } catch (e) {
      log('Erro ao parar: ' + e.message);
    }
  });

  $btnOnce.addEventListener('click', async () => {
    try {
      await postJson('/run-once');
      log('Execução única disparada.');
    } catch (e) {
      log('Erro no run-once: ' + e.message);
    }
  });
})();
</script>
{% endblock %}
